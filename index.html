// Configurações do GitHub
const GITHUB_TOKEN = 'SEU_TOKEN_AQUI'; // Substitua pelo seu token de acesso pessoal
const REPO_OWNER = 'MarcioRosa-QuickQuote';
const REPO_NAME = 'calendario-suspensoes';
const FILE_PATH = 'suspensions_2025_completo.json';

// Função para obter o conteúdo atual do JSON no GitHub
function getCurrentJson() {
  const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;
  const options = {
    method: 'get',
    headers: {
      'Authorization': `token ${GITHUB_TOKEN}`,
      'Accept': 'application/vnd.github.v3+json'
    }
  };
  const response = UrlFetchApp.fetch(url, options);
  const json = JSON.parse(response.getContentText());
  const content = Utilities.base64Decode(json.content);
  const contentString = Utilities.newBlob(content).getDataAsString();
  return JSON.parse(contentString);
}

// Função para atualizar o JSON no GitHub
function updateJson(newData) {
  const currentJson = getCurrentJson();
  const sha = currentJson.sha; // SHA do arquivo atual
  const newContent = JSON.stringify(newData, null, 2);
  const encodedContent = Utilities.base64Encode(newContent);

  const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;
  const options = {
    method: 'put',
    headers: {
      'Authorization': `token ${GITHUB_TOKEN}`,
      'Accept': 'application/vnd.github.v3+json'
    },
    payload: JSON.stringify({
      message: 'Atualiza JSON com novos dados',
      content: encodedContent,
      sha: sha
    })
  };
  UrlFetchApp.fetch(url, options);
}

// Função para inserir um novo registro
function insertSuspension() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Sheet1'); // Substitua pelo nome da sua aba
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const newSuspension = {};

  // Lê a última linha da planilha para inserir
  const lastRow = data[data.length - 1];
  headers.forEach((header, index) => {
    newSuspension[header] = lastRow[index];
  });

  const currentJson = getCurrentJson();
  currentJson.push(newSuspension);
  updateJson(currentJson);
  Logger.log('Novo registro inserido com sucesso!');
}

// Função para excluir um registro
function deleteSuspension(protocolo) {
  const currentJson = getCurrentJson();
  const updatedJson = currentJson.filter(item => item.protocolo !== protocolo);
  updateJson(updatedJson);
  Logger.log(`Registro com protocolo ${protocolo} excluído com sucesso!`);
}

// Função para sincronizar a planilha com o JSON
function syncSheetToJson() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Sheet1');
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const jsonData = [];

  // Converte os dados da planilha em JSON
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const rowData = {};
    headers.forEach((header, index) => {
      rowData[header] = row[index];
    });
    jsonData.push(rowData);
  }

  updateJson(jsonData);
  Logger.log('JSON sincronizado com a planilha!');
}
